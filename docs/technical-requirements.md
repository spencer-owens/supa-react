# Slack Clone: Technical Requirements

Below is a comprehensive overview of the data models, core functionality, authorization, and real-time requirements needed to fulfill the user stories and features we've outlined.

---

## 1. Data Models

### 1.1 User
Stores all user-related data, including authentication details, profile, and AI/autoresponder settings.

| Field                   | Type        | Description                                                                                                                                                              |
|-------------------------|------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **id**                 | UUID        | Primary key, automatically generated by Supabase Auth.                                                                                                                    |
| **email**              | text        | User's email address (from Supabase Auth).                                                                                                                               |
| **username**           | text        | Unique username for @mentions.                                                                                                                                           |
| **display_name**       | text        | Display name shown in the UI.                                                                                                                                            |
| **photo_url**          | text        | URL to profile picture in Supabase Storage.                                                                                                                              |
| **email_verified**     | boolean     | Whether email has been verified through Supabase Auth.                                                                                                                   |
| **status**            | text        | Current status: 'online', 'idle', 'busy', 'offline'.                                                                                                                     |
| **auto_status_enabled**| boolean     | Whether automatic status updates are enabled.                                                                                                                            |
| **ai_responder_mode**  | text        | 'off', 'offline', or 'on' - controls when AI responds.                                                                                                                  |
| **ai_context**        | text        | Additional context/instructions for AI responses.                                                                                                                        |
| **created_at**        | timestamptz | Creation timestamp (default: now()).                                                                                                                                     |
| **updated_at**        | timestamptz | Last update timestamp (updated via trigger).                                                                                                                             |

#### Notes:
- Authentication is handled by **Supabase Auth**.
- User presence tracked through **Supabase Presence**.
- RLS policies control access to user data.

---

### 1.2 Channel
Represents a chat space, either public or private.

| Field          | Type      | Description                                                                                     |
|----------------|----------|-------------------------------------------------------------------------------------------------|
| **id**         | UUID      | Primary key.                                                                                    |
| **name**       | text      | Channel name (e.g., "general", "marketing").                                                   |
| **type**       | text      | 'public' or 'private'.                                                                         |
| **created_by** | UUID      | Foreign key to users.id of channel creator.                                                    |
| **created_at** | timestamptz| Creation timestamp.                                                                            |
| **is_deleted** | boolean   | Soft delete flag.                                                                              |

#### Notes:
- Private channels are **hidden** through RLS policies if user is not a member.
- Only the creator can delete the channel.
- Indexed on (name) for search.

---

### 1.3 Channel Membership
Junction table for channel members with RLS policies for access control.

| Field          | Type      | Description                                                                   |
|----------------|----------|-------------------------------------------------------------------------------|
| **id**         | UUID      | Primary key.                                                                  |
| **user_id**    | UUID      | Foreign key to users.id.                                                      |
| **channel_id** | UUID      | Foreign key to channels.id.                                                   |
| **role**       | text      | Future use (e.g., 'member', 'admin'), currently just 'member'.                |
| **joined_at**  | timestamptz| When user joined this channel.                                               |

#### Notes:
- RLS policies use this table to control channel access.
- For **private** channels, membership required for any access.
- For **public** channels, membership required only for posting.

---

### 1.4 Direct Message (DM) Threads
Represents 1-on-1 conversations between users.

| Field              | Type       | Description                                                                                                               |
|--------------------|-----------|---------------------------------------------------------------------------------------------------------------------------|
| **id**             | UUID       | Primary key.                                                                                                              |
| **participants**   | UUID[]     | Array of user IDs (currently limited to 2 for 1-on-1 chats).                                                              |
| **last_message**   | UUID       | Foreign key to messages.id of most recent message.                                                                        |
| **updated_at**     | timestamptz| Last message timestamp.                                                                                                   |

#### Notes:
- **DM membership** is implicit in the `participants` array.
- RLS policies ensure only participants can access the DM.
- Indexed on participants[] for efficient lookup.

---

### 1.5 Messages
Messages for both channels and DMs.

| Field            | Type        | Description                                                                                         |
|------------------|------------|-----------------------------------------------------------------------------------------------------|
| **id**           | UUID        | Primary key.                                                                                        |
| **content**      | text        | Message text content.                                                                               |
| **sender_id**    | UUID        | Foreign key to users.id.                                                                            |
| **channel_id**   | UUID        | Foreign key to channels.id (null for DMs).                                                          |
| **dm_id**        | UUID        | Foreign key to dm_threads.id (null for channel messages).                                           |
| **thread_root_id**| UUID       | Self-reference to messages.id for thread replies (null if not a thread).                            |
| **attachments**  | jsonb       | Array of attachment objects with file metadata.                                                     |
| **created_at**   | timestamptz | Message timestamp.                                                                                  |
| **is_deleted**   | boolean     | Soft delete flag.                                                                                   |
| **is_ai**        | boolean     | Whether this message was generated by AI.                                                           |

#### Notes:
- Either channel_id or dm_id must be set, not both.
- Attachments stored in Supabase Storage, metadata in jsonb.
- Full-text search enabled on content.
- RLS policies check channel membership or DM participation.

---

### 1.6 Reactions
Junction table for message reactions.

| Field          | Type      | Description                                                                              |
|----------------|--------|------------------------------------------------------------------------------------------|
| **id**         | UUID    | Primary key.                                                                             |
| **message_id** | UUID    | Foreign key to messages.id.                                                              |
| **user_id**    | UUID    | Foreign key to users.id.                                                                 |
| **emoji**      | text    | The emoji code/name.                                                                     |
| **created_at** | timestamptz| When the reaction was added.                                                          |

#### Notes:
- Composite unique constraint on (message_id, user_id, emoji).
- RLS policies inherit from message access.
- Triggers maintain reaction counts.

---

### 1.7 Vector Embeddings
Stores message embeddings for AI features.

| Field           | Type         | Description                                                            |
|----------------|-------------|------------------------------------------------------------------------|
| **id**         | UUID         | Primary key.                                                           |
| **content_id** | UUID         | Foreign key to messages.id or other content.                           |
| **embedding**  | vector(1536) | OpenAI embedding vector.                                               |
| **content_type**| text        | Type of content ('message', 'thread', etc.).                           |
| **created_at** | timestamptz  | When the embedding was generated.                                      |

#### Notes:
- Uses pgvector extension for similarity search.
- Updated via triggers on message creation/update.
- Indexed for cosine similarity search.

---

### 1.8 AI Activity Log
Tracks AI responses for user review.

| Field           | Type      | Description                                                            |
|----------------|----------|------------------------------------------------------------------------|
| **id**         | UUID      | Primary key.                                                           |
| **user_id**    | UUID      | User the AI responded for.                                             |
| **message_id** | UUID      | The generated message.                                                 |
| **context**    | text[]    | Array of relevant context message IDs used.                            |
| **created_at** | timestamptz| When the AI response was generated.                                    |

#### Notes:
- Links to the actual message for full content.
- Includes context messages used in RAG process.
- RLS ensures users only see their own AI activity.

---

## 2. Core Functionality Requirements

### 2.1 Authentication
1. **Supabase Auth** handles sign-up/sign-in with built-in email verification.
2. **Email Verification** required before granting write privileges.
3. **Row Level Security (RLS)** policies enforce access control based on user authentication and verification status.

### 2.2 Real-Time Messaging
1. **Supabase Real-time** subscriptions on channels and DMs ensure instant message updates.
2. **Postgres NOTIFY/LISTEN** powers real-time features efficiently.
3. Default load of **50 most recent messages** with cursor-based pagination.
4. **Typing Indicators** implemented through Supabase Presence.
5. **Connection Management**:
   - Implement centralized subscription manager to handle all real-time connections
   - Limit maximum concurrent channels per client (recommended: 50)
   - Implement automatic cleanup of inactive subscriptions
   - Use multiplexing for shared resources (e.g., status updates)
   - Monitor and log connection metrics

### 2.3 Channel/DM Organization
1. **Channel Creation**: Users can create public/private channels in the channels table.
2. **Channel Membership**: RLS policies enforce read/write access based on membership.
3. **DM Creation**: Creates a dm_thread record with participants array.
4. **Deletion**: Channel creator can soft-delete via is_deleted flag.

### 2.4 File Sharing
1. **Upload**: Files up to 10MB stored in **Supabase Storage**.
2. File metadata stored in message attachments jsonb column.
3. **Download**: RLS policies on Storage bucket enforce access control.
4. **Preview**: Generated and cached through Storage transformations.

### 2.5 Search
1. **Full-text Search** using Postgres tsvector on message content.
2. **Pagination** via keyset pagination for better performance.
3. **File Search** using tsvector on attachment names in jsonb.
4. Results filtered by RLS policies automatically.

### 2.6 User Presence & Status
1. **Status Management** through Supabase Presence.
2. **Auto-Idle**: Client-side detection updates presence after 15 minutes.
3. **Offline**: Handled by Presence system with fallback to client events.
4. **Manual Status**: Stored in users table, overrides automatic status.
5. **Opt-Out**: Configurable through auto_status_enabled flag.

### 2.7 Thread Support (Channels Only)
1. **Thread Replies**: Messages reference thread_root_id in the same table.
2. **Real-time Updates**: Subscribed to thread messages via Supabase real-time.
3. **Access Control**: Inherits channel RLS policies automatically.

### 2.8 Emoji Reactions
1. **Reaction Storage**: Dedicated reactions table with user_id and message_id.
2. **Real-time Updates**: Changes broadcast through NOTIFY/LISTEN.
3. **Counts**: Maintained by Postgres triggers for efficiency.

### 2.9 Settings
1. **Profile Updates**: Changes to users table broadcast in real-time.
2. **AI Responder Mode**:
   - 'off': No AI responses
   - 'offline': AI responds when user is offline
   - 'on': AI always responds to @mentions
3. **AI Context**: Stored in users table, used in Edge Functions.

### 2.10 RAG-Powered "Ask AI" (Jonathan)
1. **/jonathan** route in the UI.
2. **User Query** â†’ **Edge Function**: Retrieves context via pgvector similarity search.
3. **LLM Response**: Stored as message with is_ai flag.
4. **Real-time Updates**: Delivered through Supabase subscriptions.

### 2.11 AI Response on Behalf of User
1. Edge Function triggered by @mentions based on user's ai_responder_mode.
2. Relevant context retrieved via pgvector similarity search.
3. Response stored as message with is_ai flag set.
4. Activity logged in ai_activity_log table.
5. Real-time notification through Supabase subscriptions.

### 2.12 Connection Management Requirements
1. **Subscription Manager**
   - Central service to track all active subscriptions
   - Automatic cleanup of inactive or unnecessary channels
   - Connection pooling for efficient resource usage
   - Clear error handling and recovery strategies

2. **Channel Organization**
   - Group related real-time updates into shared channels
   - Implement efficient channel reuse patterns
   - Clear boundaries for subscription lifetimes
   - Automatic cleanup based on user activity

3. **Resource Monitoring**
   - Track number of active channels per client
   - Monitor connection pool usage
   - Log performance metrics and errors
   - Implement automatic intervention for issues

4. **Error Handling**
   - Graceful degradation when limits are reached
   - Clear user feedback for connection issues
   - Automatic reconnection strategies
   - Fallback mechanisms for critical features

5. **Performance Optimization**
   - Connection pooling configuration
   - Efficient query patterns
   - Resource usage monitoring
   - Automatic cleanup triggers

### 2.13 Performance Optimization Requirements
1. **Message Rendering**
   - Implement virtualization for message lists
   - Use efficient pagination with cursor-based queries
   - Optimize message component re-renders
   - Implement lazy loading for media content

2. **State Management**
   - Use atomic state management for channel data
   - Separate concerns for messages, members, and typing indicators
   - Implement efficient state updates to prevent unnecessary re-renders
   - Cache frequently accessed data with TTL

3. **Database Optimization**
   - Create specific indexes for common queries:
     ```sql
     CREATE INDEX idx_messages_channel_created 
     ON messages(channel_id, created_at DESC);

     CREATE INDEX idx_messages_search 
     ON messages USING GIN(to_tsvector('english', content));
     ```
   - Implement materialized views for frequently accessed data:
     ```sql
     CREATE MATERIALIZED VIEW channel_stats AS
     SELECT 
       channel_id,
       COUNT(*) as message_count,
       MAX(created_at) as last_message_at
     FROM messages
     GROUP BY channel_id;
     ```
   - Set up automatic view refreshes on data changes

4. **Asset Management**
   - Implement lazy loading for images and attachments
   - Use optimized image sizes based on viewport
   - Provide fallback for failed asset loads
   - Configure proper caching headers

5. **Performance Monitoring**
   - Track connection and message latency
   - Monitor subscription count and channel usage
   - Implement automatic performance alerts
   - Log and analyze performance metrics

6. **Smart Caching**
   - Cache frequently accessed user data
   - Implement TTL-based cache invalidation
   - Cache channel member lists
   - Store recent message history

7. **Resource Management**
   - Implement priority levels for subscriptions
   - Track subscription access times
   - Automatic cleanup of inactive resources
   - Smart connection pooling

---

## 3. Authorization Requirements (RLS Policies)

1. **User Data Security**
   - Users can read/write their own data
   - Public fields (display_name, photo_url) readable by all
   - Presence data managed by Supabase Presence

2. **Channel Security**
   - Public channels readable by all, writable by members
   - Private channels completely hidden from non-members
   - Only creator can delete channel

3. **Channel Membership**
   - Public channels: Users can create own membership
   - Private channels: Existing members can add new members
   - Membership required for posting in all channels

4. **Message Security**
   - Channel messages require channel membership
   - DM messages require participant status
   - Edit/delete limited to sender or system
   - AI messages controlled by user preferences

5. **Storage Security**
   - Upload requires message posting permission
   - Download requires channel/DM access
   - RLS policies check membership status

6. **AI Features**
   - Edge Functions respect user AI preferences
   - Vector searches filtered by access permissions
   - AI responses follow channel/DM access rules

---

## 4. Real-Time Requirements

1. **Channels & Membership**
   - Subscribe to filtered channel list based on RLS
   - Real-time membership updates through NOTIFY/LISTEN
   - Presence updates for online members

2. **Messages**
   - Real-time subscriptions for current channel/DM
   - Cursor-based pagination for history
   - Thread messages as separate subscription

3. **Typing Indicators**
   - Managed through Supabase Presence
   - Ephemeral state with automatic cleanup
   - Channel/DM specific presence tracking

4. **User Presence**
   - Supabase Presence for online status
   - Client-side idle detection
   - Status changes broadcast in real-time

5. **Reactions**
   - Instant updates through database triggers
   - Count aggregation in real-time
   - Broadcast through NOTIFY/LISTEN

6. **Search**
   - On-demand full-text search queries
   - Results respect current RLS policies
   - Real-time updates after result selection

7. **AI Interactions**
   - Edge Function processing status updates
   - Real-time message delivery
   - Context retrieval through pgvector

---

## Conclusion

These technical requirements detail how to structure your **Supabase** implementation, including PostgreSQL tables, RLS policies, real-time subscriptions, and Edge Functions. The system leverages Supabase's built-in features: Auth for authentication, Storage for files, real-time NOTIFY/LISTEN for updates, Presence for user status, and pgvector for AI features. This architecture ensures secure, scalable, and real-time functionality while maintaining data integrity and access control through PostgreSQL's native capabilities.